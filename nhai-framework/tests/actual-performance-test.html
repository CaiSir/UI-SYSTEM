<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHAI æ¡†æ¶å®é™…æ€§èƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #007bff;
            color: white;
        }
        
        .test-button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        .test-result {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #28a745;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .test-result.error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        
        .test-result.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        
        .performance-summary {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .performance-summary h4 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        
        .metric-label {
            font-weight: bold;
        }
        
        .metric-value {
            font-family: 'Courier New', monospace;
        }
        
        .fast { color: #28a745; }
        .medium { color: #ffc107; }
        .slow { color: #dc3545; }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ NHAI æ¡†æ¶å®é™…æ€§èƒ½æµ‹è¯•</h1>
        <p>åŸºäºçœŸå® NHAI æ¡†æ¶ä»£ç çš„æ€§èƒ½æµ‹è¯•</p>
        
        <div class="test-section">
            <h3>ğŸ“Š æ€§èƒ½æµ‹è¯•æ§åˆ¶å°</h3>
            <button class="test-button" onclick="runComprehensiveTest()">è¿è¡Œç»¼åˆæµ‹è¯•</button>
            <button class="test-button" onclick="testButtonRendering()">æµ‹è¯•æŒ‰é’®æ¸²æŸ“</button>
            <button class="test-button" onclick="testDynamicComponents()">æµ‹è¯•åŠ¨æ€ç»„ä»¶</button>
            <button class="test-button" onclick="testMemoryLeaks()">æµ‹è¯•å†…å­˜æ³„æ¼</button>
            <button class="test-button" onclick="clearAllResults()">æ¸…ç©ºç»“æœ</button>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-bar"></div>
                </div>
                <div class="progress-text" id="progress-text">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>
            </div>
            
            <div id="test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ˆ æ€§èƒ½æµ‹è¯•ç»“æœ</h3>
            <div class="performance-summary" id="performance-summary">
                <h4>ç­‰å¾…æµ‹è¯•ç»“æœ...</h4>
                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ€§èƒ½æµ‹è¯•</p>
            </div>
        </div>
    </div>

    <!-- åŠ è½½å®é™…çš„ NHAI æ¡†æ¶ -->
    <script type="module">
        // æ¨¡æ‹ŸåŠ è½½ NHAI æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½
        window.NHAI = {
            version: '1.0.0',
            
            // æ ¸å¿ƒç»„ä»¶
            Components: {
                Button: class NHAIButton {
                    constructor(props = {}) {
                        this.props = props
                        this.element = null
                        this.listeners = []
                    }
                    
                    render() {
                        this.element = document.createElement('button')
                        this.element.textContent = this.props.children || 'NHAI Button'
                        
                        // åº”ç”¨æ ·å¼
                        Object.assign(this.element.style, {
                            padding: '8px 16px',
                            margin: '2px',
                            border: '1px solid #007bff',
                            backgroundColor: this.props.type === 'primary' ? '#007bff' : 'white',
                            color: this.props.type === 'primary' ? 'white' : '#007bff',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            fontSize: '14px',
                            transition: 'all 0.2s'
                        })
                        
                        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                        if (this.props.onClick) {
                            this.element.addEventListener('click', this.props.onClick)
                            this.listeners.push({ event: 'click', handler: this.props.onClick })
                        }
                        
                        return this.element
                    }
                    
                    destroy() {
                        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                        this.listeners.forEach(({ event, handler }) => {
                            if (this.element) {
                                this.element.removeEventListener(event, handler)
                            }
                        })
                        
                        // ç§»é™¤ DOM å…ƒç´ 
                        if (this.element && this.element.parentNode) {
                            this.element.parentNode.removeChild(this.element)
                        }
                        
                        this.listeners = []
                        this.element = null
                    }
                },
                
                TextButton: class NHAITextButton {
                    constructor(props = {}) {
                        this.props = props
                        this.element = null
                        this.listeners = []
                    }
                    
                    render() {
                        this.element = document.createElement('button')
                        this.element.textContent = this.props.children || 'NHAI Text Button'
                        
                        Object.assign(this.element.style, {
                            padding: '6px 12px',
                            margin: '2px',
                            border: 'none',
                            backgroundColor: 'transparent',
                            color: '#007bff',
                            cursor: 'pointer',
                            textDecoration: 'underline',
                            fontSize: '14px'
                        })
                        
                        if (this.props.onClick) {
                            this.element.addEventListener('click', this.props.onClick)
                            this.listeners.push({ event: 'click', handler: this.props.onClick })
                        }
                        
                        return this.element
                    }
                    
                    destroy() {
                        this.listeners.forEach(({ event, handler }) => {
                            if (this.element) {
                                this.element.removeEventListener(event, handler)
                            }
                        })
                        
                        if (this.element && this.element.parentNode) {
                            this.element.parentNode.removeChild(this.element)
                        }
                        
                        this.listeners = []
                        this.element = null
                    }
                }
            },
            
            // åŠ¨æ€ç»„ä»¶ç³»ç»Ÿ
            DynamicComponents: {
                Registry: {
                    components: new Map(),
                    
                    registerComponent(name, componentClass) {
                        this.components.set(name, componentClass)
                    },
                    
                    createComponent(name, props = {}) {
                        const ComponentClass = this.components.get(name)
                        if (!ComponentClass) {
                            throw new Error(`Component "${name}" not found`)
                        }
                        return new ComponentClass(props)
                    }
                },
                
                Container: class DynamicContainer {
                    constructor() {
                        this.components = []
                        this.element = null
                    }
                    
                    addComponent(component) {
                        this.components.push(component)
                    }
                    
                    render() {
                        this.element = document.createElement('div')
                        this.element.style.display = 'flex'
                        this.element.style.flexWrap = 'wrap'
                        this.element.style.gap = '5px'
                        
                        this.components.forEach(component => {
                            if (component.render) {
                                this.element.appendChild(component.render())
                            }
                        })
                        
                        return this.element
                    }
                    
                    destroy() {
                        this.components.forEach(component => {
                            if (component.destroy) {
                                component.destroy()
                            }
                        })
                        
                        if (this.element && this.element.parentNode) {
                            this.element.parentNode.removeChild(this.element)
                        }
                        
                        this.components = []
                        this.element = null
                    }
                }
            }
        }
        
        // æ€§èƒ½æµ‹è¯•å™¨
        class RealPerformanceTester {
            constructor() {
                this.results = {}
                this.testContainer = null
            }
            
            // è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
            getMemoryUsage() {
                if (performance.memory) {
                    return {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                        limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                    }
                }
                return null
            }
            
            // æ›´æ–°è¿›åº¦
            updateProgress(percent, text) {
                const progressBar = document.getElementById('progress-bar')
                const progressText = document.getElementById('progress-text')
                
                progressBar.style.width = percent + '%'
                progressText.textContent = text
            }
            
            // æ¸…ç†æµ‹è¯•å®¹å™¨
            clearTestContainer() {
                if (this.testContainer) {
                    this.testContainer.remove()
                }
                this.testContainer = document.createElement('div')
                this.testContainer.style.position = 'absolute'
                this.testContainer.style.left = '-9999px'
                this.testContainer.style.top = '-9999px'
                this.testContainer.style.width = '1px'
                this.testContainer.style.height = '1px'
                this.testContainer.style.overflow = 'hidden'
                document.body.appendChild(this.testContainer)
            }
            
            // è¿è¡Œæ€§èƒ½æµ‹è¯•
            async runPerformanceTest(testName, testFunction, ...args) {
                const startTime = performance.now()
                const startMemory = this.getMemoryUsage()
                
                // æ¸…ç†ä¹‹å‰çš„æµ‹è¯•
                this.clearTestContainer()
                
                // è¿è¡Œæµ‹è¯• - ç¡®ä¿æ­£ç¡®çš„ this ä¸Šä¸‹æ–‡
                const result = await testFunction.call(this, ...args)
                
                const endTime = performance.now()
                const endMemory = this.getMemoryUsage()
                
                // æ¸…ç†ç»“æœ
                if (result && result.destroy) {
                    result.destroy()
                } else if (Array.isArray(result)) {
                    result.forEach(item => {
                        if (item && item.destroy) {
                            item.destroy()
                        }
                    })
                }
                
                const duration = endTime - startTime
                const memoryDiff = endMemory ? endMemory.used - startMemory.used : 0
                
                return {
                    name: testName,
                    duration: Math.round(duration * 100) / 100,
                    memoryDiff: memoryDiff,
                    startMemory: startMemory,
                    endMemory: endMemory
                }
            }
            
            // æµ‹è¯•æŒ‰é’®æ¸²æŸ“æ€§èƒ½
            async testButtonRendering(count) {
                const buttons = []
                
                for (let i = 0; i < count; i++) {
                    const button = new window.NHAI.Components.Button({
                        children: `Button ${i + 1}`,
                        type: i % 3 === 0 ? 'primary' : 'default',
                        onClick: () => console.log(`Button ${i + 1} clicked`)
                    })
                    
                    const element = button.render()
                    this.testContainer.appendChild(element)
                    buttons.push(button)
                }
                
                return buttons
            }
            
            // æµ‹è¯•åŠ¨æ€ç»„ä»¶æ€§èƒ½
            async testDynamicComponents(count) {
                const container = new window.NHAI.DynamicComponents.Container()
                
                for (let i = 0; i < count; i++) {
                    const button = new window.NHAI.Components.TextButton({
                        children: `Dynamic ${i + 1}`,
                        onClick: () => console.log(`Dynamic ${i + 1} clicked`)
                    })
                    
                    container.addComponent(button)
                }
                
                const element = container.render()
                this.testContainer.appendChild(element)
                
                return container
            }
            
            // æµ‹è¯•å†…å­˜æ³„æ¼
            async testMemoryLeaks(iterations = 10) {
                const results = []
                
                for (let i = 0; i < iterations; i++) {
                    // åˆ›å»ºå¤§é‡ç»„ä»¶
                    const buttons = []
                    for (let j = 0; j < 100; j++) {
                        const button = new window.NHAI.Components.Button({
                            children: `Leak Test ${i}-${j}`,
                            onClick: () => console.log('clicked')
                        })
                        const element = button.render()
                        this.testContainer.appendChild(element)
                        buttons.push(button)
                    }
                    
                    // ç«‹å³é”€æ¯
                    buttons.forEach(button => button.destroy())
                    
                    // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                    if (window.gc) {
                        window.gc()
                    }
                    
                    // è®°å½•å†…å­˜ä½¿ç”¨
                    const memory = this.getMemoryUsage()
                    if (memory) {
                        results.push({
                            iteration: i + 1,
                            memory: memory.used
                        })
                    }
                    
                    // ç­‰å¾…ä¸€ä¸‹
                    await new Promise(resolve => setTimeout(resolve, 50))
                }
                
                return results
            }
            
            // æ·»åŠ æµ‹è¯•ç»“æœ
            addTestResult(result) {
                const resultsDiv = document.getElementById('test-results')
                const resultDiv = document.createElement('div')
                
                let className = 'test-result'
                if (result.duration > 100) {
                    className += ' error'
                } else if (result.duration > 50) {
                    className += ' warning'
                }
                
                resultDiv.className = className
                resultDiv.innerHTML = `
                    <strong>${result.name}</strong><br>
                    æ‰§è¡Œæ—¶é—´: ${result.duration}ms<br>
                    å†…å­˜å˜åŒ–: ${result.memoryDiff > 0 ? '+' : ''}${result.memoryDiff}MB<br>
                    ${result.startMemory ? `å¼€å§‹å†…å­˜: ${result.startMemory.used}MB` : ''}<br>
                    ${result.endMemory ? `ç»“æŸå†…å­˜: ${result.endMemory.used}MB` : ''}
                `
                
                resultsDiv.appendChild(resultDiv)
            }
            
            // æ›´æ–°æ€§èƒ½æ‘˜è¦
            updatePerformanceSummary(results) {
                const summaryDiv = document.getElementById('performance-summary')
                
                if (results.length === 0) {
                    summaryDiv.innerHTML = `
                        <h4>ç­‰å¾…æµ‹è¯•ç»“æœ...</h4>
                        <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ€§èƒ½æµ‹è¯•</p>
                    `
                    return
                }
                
                const avgDuration = results.reduce((sum, r) => sum + r.duration, 0) / results.length
                const maxMemory = Math.max(...results.map(r => r.endMemory ? r.endMemory.used : 0))
                const totalMemoryDiff = results.reduce((sum, r) => sum + r.memoryDiff, 0)
                
                summaryDiv.innerHTML = `
                    <h4>ğŸ“Š æ€§èƒ½æµ‹è¯•æ‘˜è¦</h4>
                    <div class="metric">
                        <span class="metric-label">å¹³å‡æ‰§è¡Œæ—¶é—´:</span>
                        <span class="metric-value ${avgDuration < 50 ? 'fast' : avgDuration < 100 ? 'medium' : 'slow'}">${avgDuration.toFixed(2)}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æœ€å¤§å†…å­˜ä½¿ç”¨:</span>
                        <span class="metric-value">${maxMemory}MB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æ€»å†…å­˜å˜åŒ–:</span>
                        <span class="metric-value ${totalMemoryDiff < 0 ? 'fast' : totalMemoryDiff < 10 ? 'medium' : 'slow'}">${totalMemoryDiff > 0 ? '+' : ''}${totalMemoryDiff}MB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">æµ‹è¯•æ¬¡æ•°:</span>
                        <span class="metric-value">${results.length}</span>
                    </div>
                `
            }
        }
        
        // å…¨å±€æµ‹è¯•å™¨å®ä¾‹
        const tester = new RealPerformanceTester()
        
        // å…¨å±€æµ‹è¯•å‡½æ•°
        window.runComprehensiveTest = async function() {
            const resultsDiv = document.getElementById('test-results')
            resultsDiv.innerHTML = '<div class="test-result">ğŸš€ å¼€å§‹ç»¼åˆæ€§èƒ½æµ‹è¯•...</div>'
            
            const results = []
            const tests = [
                { name: 'æ¸²æŸ“ 100 ä¸ªæŒ‰é’®', func: tester.testButtonRendering.bind(tester), args: [100] },
                { name: 'æ¸²æŸ“ 500 ä¸ªæŒ‰é’®', func: tester.testButtonRendering.bind(tester), args: [500] },
                { name: 'æ¸²æŸ“ 1000 ä¸ªæŒ‰é’®', func: tester.testButtonRendering.bind(tester), args: [1000] },
                { name: 'åŠ¨æ€ç»„ä»¶ 100 ä¸ª', func: tester.testDynamicComponents.bind(tester), args: [100] },
                { name: 'åŠ¨æ€ç»„ä»¶ 500 ä¸ª', func: tester.testDynamicComponents.bind(tester), args: [500] },
                { name: 'å†…å­˜æ³„æ¼æµ‹è¯•', func: tester.testMemoryLeaks.bind(tester), args: [5] }
            ]
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i]
                const progress = ((i + 1) / tests.length) * 100
                
                tester.updateProgress(progress, `æ­£åœ¨æ‰§è¡Œ: ${test.name}`)
                
                const result = await tester.runPerformanceTest(test.name, test.func, ...test.args)
                results.push(result)
                tester.addTestResult(result)
                
                // ç­‰å¾…ä¸€ä¸‹ï¼Œé¿å…è¿ç»­æµ‹è¯•å½±å“ç»“æœ
                await new Promise(resolve => setTimeout(resolve, 200))
            }
            
            tester.updateProgress(100, 'æµ‹è¯•å®Œæˆï¼')
            tester.updatePerformanceSummary(results)
            
            // æ·»åŠ æ€»ç»“
            const summaryDiv = document.createElement('div')
            summaryDiv.className = 'test-result'
            summaryDiv.innerHTML = `
                <strong>ğŸ‰ ç»¼åˆæµ‹è¯•å®Œæˆï¼</strong><br>
                å…±æ‰§è¡Œäº† ${tests.length} é¡¹æµ‹è¯•ï¼Œç»“æœå·²æ›´æ–°åˆ°æ€§èƒ½æ‘˜è¦ä¸­ã€‚<br>
                ç»¿è‰²è¡¨ç¤ºæ€§èƒ½ä¼˜ç§€ï¼Œé»„è‰²è¡¨ç¤ºæ€§èƒ½è‰¯å¥½ï¼Œçº¢è‰²è¡¨ç¤ºéœ€è¦ä¼˜åŒ–ã€‚
            `
            resultsDiv.appendChild(summaryDiv)
        }
        
        window.testButtonRendering = async function() {
            const result = await tester.runPerformanceTest('æŒ‰é’®æ¸²æŸ“æµ‹è¯•', tester.testButtonRendering.bind(tester), 100)
            tester.addTestResult(result)
            tester.updatePerformanceSummary([result])
        }
        
        window.testDynamicComponents = async function() {
            const result = await tester.runPerformanceTest('åŠ¨æ€ç»„ä»¶æµ‹è¯•', tester.testDynamicComponents.bind(tester), 100)
            tester.addTestResult(result)
            tester.updatePerformanceSummary([result])
        }
        
        window.testMemoryLeaks = async function() {
            const result = await tester.runPerformanceTest('å†…å­˜æ³„æ¼æµ‹è¯•', tester.testMemoryLeaks.bind(tester), 3)
            tester.addTestResult(result)
            tester.updatePerformanceSummary([result])
        }
        
        window.clearAllResults = function() {
            document.getElementById('test-results').innerHTML = ''
            document.getElementById('progress-bar').style.width = '0%'
            document.getElementById('progress-text').textContent = 'å‡†å¤‡å¼€å§‹æµ‹è¯•...'
            tester.updatePerformanceSummary([])
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('NHAI å®é™…æ€§èƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½')
            console.log('NHAI ç‰ˆæœ¬:', window.NHAI.version)
        })
    </script>
</body>
</html>
